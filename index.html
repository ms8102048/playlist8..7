<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>極速播放器</title>
  <style>
    body { background: #000; color: #fff; margin: 0; padding: 10px; font-family: sans-serif; box-sizing: border-box; }
    #UI { transition: all 0.3s; }
    textarea { width: 100%; height: 80px; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; padding: 5px; font-size: 14px; }
    #C { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
    .btn-num { min-width: 45px; height: 40px; background: #222; color: #fff; border: 1px solid #444; }
    .btn-ctrl { flex-grow: 1; height: 40px; background: #444; color: #fff; }
    video { width: 100%; background: #000; border-radius: 4px; }
  </style>
</head>
<body>

<div id="UI">
  <textarea id="L" placeholder="在此貼入清單 (格式: 名稱$網址)"></textarea>
  <div id="C"></div>
</div>

<div class="btn-group">
  <button id="T" class="btn-ctrl">收合/展開清單</button>
  <button id="N" class="btn-ctrl" style="background: #a00;">▶ 下一集</button>
</div>

<video id="V" controls autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  const d = document, L = d.getElementById("L"), V = d.getElementById("V"), C = d.getElementById("C"), UI = d.getElementById("UI"), T = d.getElementById("T"), N = d.getElementById("N");
  let hls = null;

  // 1. 初始化讀取
  window.onload = () => {
    const s = localStorage.getItem("tv_l");
    if (s) {
      L.value = s;
      gen();
      const u = localStorage.getItem("tv_u"), t = localStorage.getItem("tv_t");
      if (u) load(u, t);
    }
  };

  // 2. 收合功能
  T.onclick = () => UI.style.display = UI.style.display === 'none' ? 'block' : 'none';

  // 3. 生成按鈕
  function gen() {
    const lines = L.value.split('\n').filter(l => l.includes('http'));
    C.innerHTML = '';
    lines.forEach((l, i) => {
      const u = l.split('$').pop().trim();
      const b = d.createElement("button");
      b.className = "btn-num";
      b.innerText = (i + 1);
      b.dataset.u = u;
      b.onclick = () => load(u, 0);
      C.appendChild(b);
    });
    hi(V.dataset.u);
  }

  // 4. 播放影片
  function load(u, t) {
    V.dataset.u = u;
    hi(u);
    if (hls) hls.destroy();
    if (Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(u);
      hls.attachMedia(V);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        if (t > 0) V.currentTime = t;
        V.play().catch(() => {});
      });
    } else if (V.canPlayType('application/vnd.apple.mpegurl')) {
      V.src = u;
      if (t > 0) V.currentTime = t;
    }
  }

  // 5. 播放下一集
  N.onclick = () => {
    const bs = Array.from(d.querySelectorAll(".btn-num"));
    const i = bs.findIndex(b => b.dataset.u === V.dataset.u);
    if (i !== -1 && i < bs.length - 1) bs[i + 1].click();
  };

  // 6. 輔助功能：高亮與連播
  function hi(u) {
    d.querySelectorAll(".btn-num").forEach(b => {
      const a = b.dataset.u === u;
      b.style.background = a ? "#0f0" : "#222";
      b.style.color = a ? "#000" : "#fff";
    });
  }

  L.oninput = () => {
    localStorage.setItem("tv_l", L.value);
    gen();
  };

  setInterval(() => {
    if (V.currentTime > 0 && !V.paused) {
      localStorage.setItem("tv_u", V.dataset.u);
      localStorage.setItem("tv_last_time", V.currentTime);
    }
  }, 3000);

  V.onended = () => N.click();
</script>

</body>
</html>