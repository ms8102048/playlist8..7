<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Git æ’­æ”¾å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
  <style>
    body { background: #000; color: #fff; margin: 0; padding: 10px; font-family: sans-serif; box-sizing: border-box; }
    #UI { transition: all 0.3s; }
    textarea { width: 100%; height: 80px; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; padding: 5px; font-size: 14px; margin-bottom: 5px; }
    #C { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
    
    .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
    button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; flex: 1; height: 40px; font-size: 12px; white-space: nowrap; }
    
    .btn-num { min-width: 45px; height: 40px; background: #222; color: #fff; border: 1px solid #444; flex: none; }
    .btn-ctrl { background: #444; color: #fff; }
    #BtnRead { background: #1a3a5a; color: #8cf; border: 1px solid #2d5a88; }
    #BtnWrite { background: #1a5a2a; color: #8f8; border: 1px solid #2d884a; }
    
    /* è‡ªå‹•åŒæ­¥æŒ‰éˆ•æ¨£å¼ï¼šåƒ…åç¨±ï¼Œé¡è‰²å€åˆ†ç‹€æ…‹ */
    #BtnAuto { background: #333; color: #888; border: 1px solid #444; }
    #BtnAuto.on { background: #822; color: #fcc; border: 1px solid #a33; }
    
    #dplayer { width: 100%; min-height: 380px; aspect-ratio: 16/9; background: #000; border-radius: 4px; }
    #AutoNotice { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 128, 0, 0.9); color: white; padding: 8px 16px; border-radius: 20px; z-index: 9999; display: none; font-size: 14px; }
    .dplayer-icons-right { display: flex !important; align-items: center; }
  </style>
</head>
<body>

<div id="AutoNotice">æˆåŠŸ</div>

<div id="UI">
  <textarea id="L" placeholder="æ ¼å¼: åç¨±$ç¶²å€"></textarea>
  <div id="C"></div>
</div>

<div class="btn-group">
  <button id="T" class="btn-ctrl">å±•é–‹/æ”¶åˆ</button>
  <button id="BtnRead" class="btn-ctrl">è®€å–åŒæ­¥</button>
  <button id="BtnWrite" class="btn-ctrl">å¯«å…¥åŒæ­¥</button>
  <button id="BtnAuto" class="btn-ctrl">è‡ªå‹•åŒæ­¥</button>
</div>

<div id="dplayer"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/dplayer@latest"></script>
<script>
  const d = document, L = d.getElementById("L"), C = d.getElementById("C"), UI = d.getElementById("UI"), T = d.getElementById("T"), NT = d.getElementById("AutoNotice");
  const BtnRead = d.getElementById("BtnRead"), BtnWrite = d.getElementById("BtnWrite"), BtnAuto = d.getElementById("BtnAuto");
  let dp = null, isAuto = false;

  const API_URL = "https://script.google.com/macros/s/AKfycbwDWdmTharCjjY6-k7-p8ZbOfUSfgJzVY5ozoGIU_8b-Pz9MuXIfLvFT98Rg65AzuwUlw/exec";

  function showNotice(msg) {
    NT.innerText = msg; NT.style.display = 'block';
    setTimeout(() => { NT.style.display = 'none'; }, 1000);
  }

  function toggleAuto(state, syncToCloud = true) {
    isAuto = (state === true || state === "true");
    isAuto ? BtnAuto.classList.add("on") : BtnAuto.classList.remove("on");
    localStorage.setItem("tv_auto", isAuto);
    if (syncToCloud) uploadData(true);
  }

  BtnAuto.onclick = () => toggleAuto(!isAuto);

  function fetchCloudData(isInitial = false) {
    if (!isInitial) BtnRead.innerText = "è®€å–ä¸­...";
    const cbName = 'jsonp_' + Date.now();
    const script = d.createElement('script');
    window[cbName] = (data) => {
      if (data && data.list) {
        L.value = data.list;
        localStorage.setItem("tv_l", data.list);
        gen();
        // ç¢ºä¿å…ˆåŠ è¼‰å½±ç‰‡ï¼Œå†é€²è¡Œè·³è½‰
        if (data.url) load(data.url, data.time || 0);
        if (data.auto !== undefined) toggleAuto(data.auto, false);
        if (!isInitial) showNotice("âœ… è®€å–æˆåŠŸ");
      }
      delete window[cbName]; d.body.removeChild(script);
      BtnRead.innerText = "è®€å–åŒæ­¥";
    };
    script.src = `${API_URL}?callback=${cbName}&t=${Date.now()}`;
    d.body.appendChild(script);
  }

  function uploadData(isSilent = false) {
    if (!isSilent) BtnWrite.innerText = "å¯«å…¥ä¸­...";
    // ç²å–ç•¶å‰ç²¾ç¢ºæ™‚é–“
    const curTime = dp ? dp.video.currentTime : (localStorage.getItem("tv_last_time") || 0);
    const curUrl = dp ? dp.video.dataset.u : (localStorage.getItem("tv_u") || "");
    
    const payload = {
      list: L.value,
      url: curUrl,
      time: curTime,
      auto: isAuto
    };
    
    fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
    .then(() => { 
      if (!isSilent) { showNotice("ğŸ’¾ å¯«å…¥æˆåŠŸ"); BtnWrite.innerText = "å¯«å…¥åŒæ­¥"; } 
    });
  }

  BtnRead.onclick = () => fetchCloudData(false);
  BtnWrite.onclick = () => uploadData(false);

  window.onload = () => {
    const saved = localStorage.getItem("tv_l");
    if (saved) { L.value = saved; gen(); }
    const u = localStorage.getItem("tv_u"), t = localStorage.getItem("tv_last_time");
    if (u) load(u, t);
    fetchCloudData(true);
  };

  // æ¯ä¸€åˆ†é˜åŒæ­¥ä¸€æ¬¡é€²åº¦ï¼Œç¢ºä¿ç§’æ•¸å¯«å…¥
  setInterval(() => {
    if (isAuto && dp && !dp.video.paused && dp.video.currentTime > 0) {
      uploadData(true);
    }
  }, 60000);

  T.onclick = () => UI.style.display = UI.style.display === 'none' ? 'block' : 'none';
  
  function gen() {
    const lines = L.value.split('\n').filter(l => l.includes('http'));
    C.innerHTML = '';
    lines.forEach((l, i) => {
      const u = l.split('$').pop().trim();
      const b = d.createElement("button");
      b.className = "btn-num"; b.innerText = (i + 1); b.dataset.u = u;
      b.onclick = () => { load(u, 0); if(isAuto) setTimeout(()=>uploadData(true), 1000); };
      C.appendChild(b);
    });
    if (dp) hi(dp.video.dataset.u);
  }

  function load(u, t) {
    hi(u);
    if (dp) {
        dp.switchVideo({ url: u, type: 'hls' });
        dp.video.dataset.u = u;
        // å¢åŠ å»¶é²è·³è½‰ï¼Œç¢ºä¿å½±ç‰‡è¼‰å…¥å¾Œç§’æ•¸æ­£ç¢º
        setTimeout(() => { if (t > 0) dp.seek(t); dp.play(); }, 500);
    } else {
        dp = new DPlayer({ container: d.getElementById('dplayer'), autoplay: true, hotkey: true, video: { url: u, type: 'hls' } });
        dp.video.dataset.u = u; 
        setTimeout(() => { if (t > 0) dp.seek(t); }, 500);
        dp.on('ended', () => nextVideo());
        // åŸæœ‰æ§åˆ¶æŒ‰éˆ•...
        const btnBox = d.createElement('div'); btnBox.style.cssText = 'display:flex; align-items:center;';
        const curEp = d.createElement('div'); curEp.id = "curEp"; curEp.style.cssText = 'font-size:11px; color:#0a0; border:1px solid #050; padding:1px 6px; border-radius:3px; margin-top:8px; margin-right:4px; font-weight:bold;';
        const createQuickBtn = (text, action) => {
            const btn = d.createElement('div'); btn.className = 'dplayer-icon'; btn.style.cssText = 'width:auto; padding:0 3px; display:flex; align-items:center; cursor:pointer;';
            btn.innerHTML = `<div style="font-size:18px; line-height:1; margin-top:5px;">${text}</div>`;
            btn.onclick = (e) => { e.stopPropagation(); action(); };
            return btn;
        };
        btnBox.appendChild(curEp); btnBox.appendChild(createQuickBtn('âª', () => { dp.seek(dp.video.currentTime - 10); })); btnBox.appendChild(createQuickBtn('â†©ï¸', () => { dp.seek(85); })); btnBox.appendChild(createQuickBtn('â­ï¸', () => { nextVideo(); }));
        const ir = d.querySelector('.dplayer-icons-right'); if (ir) ir.insertBefore(btnBox, ir.firstChild);
        updateEpDisp(u); 
    }
  }

  function nextVideo() { const bs = Array.from(d.querySelectorAll(".btn-num")); const u = dp ? dp.video.dataset.u : ""; const i = bs.findIndex(b => b.dataset.u === u); if (i !== -1 && i < bs.length - 1) bs[i + 1].click(); }
  function updateEpDisp(u) { const bs = Array.from(d.querySelectorAll(".btn-num")); const i = bs.findIndex(b => b.dataset.u === u); const el = d.getElementById("curEp"); if (el) el.innerText = i !== -1 ? `ç¬¬ ${i + 1} é›†` : ""; }
  function hi(u) { updateEpDisp(u); d.querySelectorAll(".btn-num").forEach(b => { const a = b.dataset.u === u; b.style.background = a ? "#0f0" : "#222"; b.style.color = a ? "#000" : "#fff"; }); }
  L.oninput = () => { localStorage.setItem("tv_l", L.value); gen(); };
  
  // æ¯3ç§’æœ¬åœ°æš«å­˜ä¸€æ¬¡
  setInterval(() => {
    if (dp && dp.video.currentTime > 0 && !dp.video.paused) {
      localStorage.setItem("tv_u", dp.video.dataset.u);
      localStorage.setItem("tv_last_time", dp.video.currentTime);
    }
  }, 3000);
</script>
</body>
</html>